"use strict";(self.webpackChunkvuepress_theme_reco_demo=self.webpackChunkvuepress_theme_reco_demo||[]).push([[7233],{5940:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-0b25f91c",path:"/blogs/tech/DockerHub%E7%BB%93%E5%90%88actions.html",title:"DockerHub结合actions",lang:"en-US",frontmatter:{title:"DockerHub结合actions",date:"2021/10/02",tags:["dockerfile","docker"],categories:["tech"]},excerpt:"<p><strong>本文阅读大概需要 3 分钟</strong></p>\n",headers:[{level:2,title:"DockerHub 结合 actions",slug:"dockerhub-结合-actions",children:[{level:3,title:"1.往仓库加两个 SECRET",slug:"_1-往仓库加两个-secret",children:[]},{level:3,title:"2. .github/workflows",slug:"_2-github-workflows",children:[]},{level:3,title:"3. 优化",slug:"_3-优化",children:[]}]}],git:{},filePathRelative:"blogs/tech/DockerHub结合actions.md"}},7644:(n,s,a)=>{a.r(s),a.d(s,{default:()=>m});var p=a(6252);const t=(0,p.uE)('<p><strong>本文阅读大概需要 3 分钟</strong></p><h2 id="dockerhub-结合-actions" tabindex="-1"><a class="header-anchor" href="#dockerhub-结合-actions" aria-hidden="true">#</a> DockerHub 结合 actions</h2><p><strong>如果你使用<code>Docker hub</code>平台来管理镜像，那么结合<code>git actions</code>来自动 CI 发布多是一件美事啊~</strong></p><p><strong>默认前提都是公有 public 仓库</strong></p><h3 id="_1-往仓库加两个-secret" tabindex="-1"><a class="header-anchor" href="#_1-往仓库加两个-secret" aria-hidden="true">#</a> 1.往仓库加两个 SECRET</h3>',5),e=(0,p.Uk)("分别是"),c=(0,p._)("code",null,"DOCKER_HUB_USERNAME",-1),u=(0,p.Uk)("， "),l=(0,p._)("code",null,"DOCKER_HUB_ACCESS_TOKEN",-1),o=(0,p.Uk)(),r={href:"https://hub.docker.com/settings/security",target:"_blank",rel:"noopener noreferrer"},i=(0,p.Uk)("Token 这里生成"),k=(0,p.uE)('<h3 id="_2-github-workflows" tabindex="-1"><a class="header-anchor" href="#_2-github-workflows" aria-hidden="true">#</a> 2. .github/workflows</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># .github/workflows/ci.yml</span>\n<span class="token key atrule">name</span><span class="token punctuation">:</span> push to dockerhub\n<span class="token key atrule">on</span><span class="token punctuation">:</span>\n  <span class="token key atrule">push</span><span class="token punctuation">:</span>\n    <span class="token key atrule">branches</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> master\n    <span class="token key atrule">tags</span><span class="token punctuation">:</span>\n      <span class="token punctuation">-</span> <span class="token string">&#39;v*&#39;</span>\n<span class="token key atrule">jobs</span><span class="token punctuation">:</span>\n  <span class="token key atrule">build</span><span class="token punctuation">:</span>\n    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest\n    <span class="token key atrule">steps</span><span class="token punctuation">:</span>\n      <span class="token comment"># pull the latest code</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout\n        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2\n      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Login to Docker Hub\n        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v1\n        <span class="token key atrule">with</span><span class="token punctuation">:</span>\n          <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>\n          <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_ACCESS_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx\n        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1\n\n      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and push\n        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2\n        <span class="token key atrule">with</span><span class="token punctuation">:</span>\n          <span class="token comment"># Dockerfile所处的位置</span>\n          <span class="token key atrule">context</span><span class="token punctuation">:</span> ./Docker<span class="token punctuation">-</span>main\n          <span class="token key atrule">builder</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.buildx.outputs.name <span class="token punctuation">}</span><span class="token punctuation">}</span>\n          <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n          <span class="token comment"># 修改下面的仓库名</span>\n          <span class="token key atrule">tags</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>/你的仓库名<span class="token punctuation">:</span>latest\n      <span class="token comment"># 结合微信机器人推送成功消息(非必需)，如需，另加一个SECRET。</span>\n      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WeChat Work notification by text\n        <span class="token key atrule">uses</span><span class="token punctuation">:</span> chf007/action<span class="token punctuation">-</span>wechat<span class="token punctuation">-</span>work@master\n        <span class="token key atrule">env</span><span class="token punctuation">:</span>\n          <span class="token key atrule">WECHAT_WORK_BOT_WEBHOOK</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span>secrets.WECHAT_WORK_BOT_WEBHOOK<span class="token punctuation">}</span><span class="token punctuation">}</span>\n        <span class="token key atrule">with</span><span class="token punctuation">:</span>\n          <span class="token key atrule">msgtype</span><span class="token punctuation">:</span> text\n          <span class="token key atrule">content</span><span class="token punctuation">:</span> action 完成！\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="_3-优化" tabindex="-1"><a class="header-anchor" href="#_3-优化" aria-hidden="true">#</a> 3. 优化</h3><p><strong>推过一次后，我们希望能利用缓存，减少时间，便捷高效的处理</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># .github/workflows/ci.yml</span>\n \t  <span class="token punctuation">-</span>\n        <span class="token key atrule">name</span><span class="token punctuation">:</span> Login to Docker Hub\n        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v1\n        <span class="token key atrule">with</span><span class="token punctuation">:</span>\n          <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>\n          <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_ACCESS_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>\n      <span class="token punctuation">-</span>\n        <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and push\n        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2\n        <span class="token key atrule">with</span><span class="token punctuation">:</span>\n          <span class="token key atrule">context</span><span class="token punctuation">:</span> ./\n          <span class="token key atrule">file</span><span class="token punctuation">:</span> ./Dockerfile\n          <span class="token key atrule">builder</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.buildx.outputs.name <span class="token punctuation">}</span><span class="token punctuation">}</span>\n          <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n          <span class="token key atrule">tags</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>/你的仓库名<span class="token punctuation">:</span>latest\n          <span class="token key atrule">cache-from</span><span class="token punctuation">:</span> type=registry<span class="token punctuation">,</span>ref=$<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>/你的仓库名<span class="token punctuation">:</span>buildcache\n          <span class="token key atrule">cache-to</span><span class="token punctuation">:</span> type=registry<span class="token punctuation">,</span>ref=$<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.DOCKER_HUB_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span>/你的仓库名<span class="token punctuation">:</span>buildcache<span class="token punctuation">,</span>mode=max\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div>',5),b={},m=(0,a(3744).Z)(b,[["render",function(n,s){const a=(0,p.up)("ExternalLinkIcon");return(0,p.wg)(),(0,p.iD)(p.HY,null,[t,(0,p._)("p",null,[(0,p._)("strong",null,[e,c,u,l,o,(0,p._)("a",r,[i,(0,p.Wm)(a)])])]),k],64)}]])}}]);